{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    
    <h2>{% if action == 'create' %}新規カルテ作成{% else %}カルテ編集 (ID: {{ karte.karte_id }}){% endif %}</h2>
    <hr>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" action="{% if action == 'create' %}{{ url_for('create_karte') }}{% else %}{{ url_for('edit_karte', karte_id=karte.karte_id) }}{% endif %}">
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="date" class="form-label">日付</label>
                <input type="date" class="form-control" id="date" name="date" 
                       value="{{ karte.date if karte and karte.date else today }}" required>
            </div>
            
            <div class="col-md-3 mb-3">
                <label for="player_id" class="form-label">選手名 (必須)</label>
                <select name="player_id" id="player_id" class="form-select" required>
                    <option value="" {% if not karte or not karte.player_id %}selected{% endif %}>選手を選択</option>
                    {% for player in player_list %}
                        <option value="{{ player.player_id }}" 
                                {% if karte and (karte.player_id | string == player.player_id | string) %}selected{% endif %}>
                            {{ player.player_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3 mb-3">
                <label for="tr" class="form-label">トレーナー/担当者</label>
                <input type="text" class="form-control" id="tr" name="tr" 
                       value="{{ karte.tr if karte and karte.tr else '' }}">
            </div>

            <div class="col-md-3 mb-3">
                <label for="time_loss_category" class="form-label">タイムロス区分</label>
                <select name="time_loss_category" id="time_loss_category" class="form-select">
                    {% for tl in TIME_LOSS_OPTIONS %}
                        <option value="{{ tl }}" 
                                {% if karte and karte.time_loss_category == tl %}selected{% endif %}>
                            {{ tl }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="time_loss" class="form-label">タイムロス日数/期間</label>
                <input type="text" class="form-control" id="time_loss" name="time_loss" 
                       value="{{ karte.time_loss if karte and karte.time_loss else '' }}" placeholder="例: 3days または 2weeks">
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="diagnosis_flag" name="diagnosis_flag"
                           {% if karte and karte.diagnosis_flag %}checked{% endif %}>
                    <label class="form-check-label" for="diagnosis_flag">診断確定済</label>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h4>SOAP 記録</h4>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="s_content" class="form-label">S (主訴)</label>
                    <textarea class="form-control" id="s_content" name="s_content" rows="3">{{ karte.s_content if karte and karte.s_content else '' }}</textarea>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="o_content" class="form-label">O (客観的所見)</label>
                    <textarea class="form-control" id="o_content" name="o_content" rows="3">{{ karte.o_content if karte and karte.o_content else '' }}</textarea>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="a_content" class="form-label">A (評価・考察)</label>
                    <textarea class="form-control" id="a_content" name="a_content" rows="3">{{ karte.a_content if karte and karte.a_content else '' }}</textarea>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="p_content" class="form-label">P (計画・治療)</label>
                    <textarea class="form-control" id="p_content" name="p_content" rows="3">{{ karte.p_content if karte and karte.p_content else '' }}</textarea>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h4>傷害詳細</h4>
            <div class="row">
                {% for key, details in PULLDOWN_OPTIONS.items() %}
                <div class="col-md-3 mb-3">
                    <label for="{{ key }}" class="form-label">{{ details.label }}</label>
                    <select name="{{ key }}" id="{{ key }}" class="form-select">
                        <option value="">-- 選択なし --</option>
                        {% for option in details.options %}
                            <option value="{{ option }}" 
                                    {% if karte and (karte[key] | string == option | string) %}selected{% endif %}>
                                {{ option }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="d-flex justify-content-between">
            <div>
                <button type="submit" class="btn btn-primary me-2">保存</button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">キャンセル</a>
            </div>
            {% if action == 'edit' %}
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    削除
                </button>
            {% endif %}
        </div>
    </form>
    
    {% if action == 'edit' %}
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteModalLabel">削除確認</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        このカルテを本当に削除しますか？操作は取り消せません。
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                        <form method="POST" action="{{ url_for('delete_karte', karte_id=karte.karte_id) }}" style="display:inline;">
                            <input type="hidden" name="_method" value="DELETE">
                            <button type="submit" class="btn btn-danger">削除実行</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

</div>
{% endblock %}