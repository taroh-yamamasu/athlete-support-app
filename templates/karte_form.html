{% extends "base.html" %}
{% block title %}ã‚«ãƒ«ãƒ†å…¥åŠ›{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>{% if action == 'create' %}æ–°è¦ä½œæˆ{% else %}ç·¨é›† (ID: {{ karte.karte_id }}){% endif %}</h2>
        
        {% if action == 'edit' %}
            <a href="/create_karte?copy_player_id={{ karte.player_id }}&copy_from_id={{ karte.karte_id }}" class="btn btn-outline-info">
                <i class="fas fa-copy"></i> ã“ã®ã‚«ãƒ«ãƒ†ã‚’å†åˆ©ç”¨ã—ã¦æ–°è¦ä½œæˆ
            </a>
        {% endif %}
    </div>

    <form method="POST">
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">æ—¥ä»˜</label>
                <input type="date" class="form-control" name="date" value="{{ karte.date if karte else today }}" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">é¸æ‰‹</label>
                <div class="input-group">
                    <select class="form-select" id="playerSelect" name="player_id" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        {% for p in player_list %}
                        <option value="{{ p.player_id }}" {% if karte and karte.player_id == p.player_id %}selected{% endif %}>
                            {{ p.player_name }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if action == 'create' %}
                        <button type="button" id="copyButton" class="btn btn-outline-info" style="display:none;" title="ç›´è¿‘ã®ã‚«ãƒ«ãƒ†å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">TRæ‹…å½“</label>
                <input type="text" class="form-control" name="tr" value="{{ karte.tr if karte else '' }}">
            </div>
            <div class="col-md-6">
                <label class="form-label">Time Loss å‚™è€ƒ</label>
                <input type="text" class="form-control" name="time_loss" value="{{ karte.time_loss if karte else '' }}" placeholder="æ—¥æ•°ãªã©è£œè¶³æƒ…å ±ãŒã‚ã‚Œã°è¨˜å…¥">
            </div>
        </div>

        <div class="card mb-3 bg-light">
            <div class="card-body">
                <label class="form-label fw-bold">Time Loss ã‚«ãƒ†ã‚´ãƒª</label>
                <div>
                    {% for option in TIME_LOSS_OPTIONS %}
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="time_loss_category" value="{{ option }}" 
                               {% if karte and karte.time_loss_category == option %}checked{% elif not karte and loop.first %}checked{% endif %}>
                        <label class="form-check-label">{{ option }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold bg-secondary text-white px-2 rounded">S (ä¸»è¦³) è©³ç´°ãƒ‡ãƒ¼ã‚¿</label>
            <div class="row g-2 mb-2">
                {% for key, item in PULLDOWN_OPTIONS.items() %}
                <div class="col-md-4">
                    <label class="small text-muted">{{ item.label }}</label>
                    <select class="form-select form-select-sm" name="{{ key }}">
                        <option value="">-</option>
                        {% for opt in item.options %}
                        <option value="{{ opt }}" {% if karte and karte[key] == opt %}selected{% endif %}>{{ opt }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}
            </div>
            <label class="form-label small">S è‡ªç”±è¨˜è¿°</label>
            <textarea class="form-control" name="s_content" rows="3">{{ karte.s_content if karte else '' }}</textarea>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold bg-primary text-white px-2 rounded">O (å®¢è¦³)</label>
            <textarea class="form-control" name="o_content" rows="3">{{ karte.o_content if karte else '' }}</textarea>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold bg-success text-white px-2 rounded">A (è©•ä¾¡)</label>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" name="diagnosis_flag" {% if karte and karte.diagnosis_flag %}checked{% endif %}>
                <label class="form-check-label">åŒ»å¸«ã®è¨ºæ–­ã‚ã‚Š</label>
            </div>
            <textarea class="form-control" name="a_content" rows="3">{{ karte.a_content if karte else '' }}</textarea>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold bg-warning text-dark px-2 rounded">P (è¨ˆç”»)</label>
            <textarea class="form-control" name="p_content" rows="3">{{ karte.p_content if karte else '' }}</textarea>
        </div>

        <button type="submit" class="btn btn-success">ä¿å­˜</button>
        <a href="/" class="btn btn-secondary">æˆ»ã‚‹</a>
    </form>
    
    {% if action == 'edit' %}
    <form method="POST" action="/karte/delete/{{ karte.karte_id }}" class="mt-4 text-end">
        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">ğŸ—‘ï¸ ã“ã®ã‚«ãƒ«ãƒ†ã‚’å‰Šé™¤</button>
    </form>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const playerSelect = document.getElementById('playerSelect');
        const copyButton = document.getElementById('copyButton');
        const currentUrl = window.location.href.split('?')[0];

        // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç”Ÿæˆï¼ˆplayer_idä¿æŒç”¨ï¼‰
        const hiddenPlayerIdInput = document.createElement('input');
        hiddenPlayerIdInput.type = 'hidden';
        hiddenPlayerIdInput.name = 'player_id';
        document.querySelector('form').prepend(hiddenPlayerIdInput); 

        function updateCopyButton() {
            const selectedPlayerId = playerSelect.value;
            if (copyButton) {
                if (selectedPlayerId) {
                    copyButton.style.display = 'block';
                    copyButton.onclick = function() {
                        window.location.href = currentUrl + '?copy_player_id=' + selectedPlayerId;
                    };
                } else {
                    copyButton.style.display = 'none';
                }
            }
        }

        updateCopyButton();
        playerSelect.addEventListener('change', updateCopyButton);
        
        // ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã€éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«IDã‚’å…¥ã‚Œã¦ã‹ã‚‰ç„¡åŠ¹åŒ–ã™ã‚‹
        {% if karte and request.args.get('copy_player_id') %}
            hiddenPlayerIdInput.value = "{{ karte.player_id }}";
            playerSelect.disabled = true;
            playerSelect.classList.add('bg-warning', 'bg-opacity-25');
        {% endif %}
    });
</script>
{% endblock %}