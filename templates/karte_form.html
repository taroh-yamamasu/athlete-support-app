{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    
    <div class="d-flex justify-content-between align-items-end">
        <h2>{% if action == 'create' %}æ–°è¦ã‚«ãƒ«ãƒ†ä½œæˆ{% else %}ã‚«ãƒ«ãƒ†ç·¨é›† (ID: {{ karte.karte_id }}){% endif %}</h2>
    </div>
    <hr>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" action="{% if action == 'create' %}{{ url_for('create_karte') }}{% else %}{{ url_for('edit_karte', karte_id=karte.karte_id) }}{% endif %}">
        
        <div class="card mb-4 border-warning shadow-sm">
            <div class="card-header bg-warning text-dark d-flex align-items-center">
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" role="switch" id="report_flag" name="report_flag" 
                           onchange="toggleReportFields()" {% if karte and karte.report_flag %}checked{% endif %}>
                    <label class="form-check-label fw-bold" for="report_flag">ã‚³ãƒ¼ãƒã¸ã®å‚·ç—…å ±å‘Šãƒ»å‚åŠ å¯å¦å…±æœ‰ã‚’è¡Œã†</label>
                </div>
            </div>
            <div class="card-body bg-light" id="report_fields" style="display: none;">
                <p class="text-muted small mb-3">â€»ã“ã“ã«è¨˜å…¥ã—ãŸå†…å®¹ã¯ã€Œã‚³ãƒ¼ãƒé–²è¦§ç”¨ç”»é¢ã€ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚å°‚é–€ç”¨èªã¯é¿ã‘ã€ã‚ã‹ã‚Šã‚„ã™ã„è¨€è‘‰ã§è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚</p>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">å‚·ç—…å (ã‚³ãƒ¼ãƒå…±æœ‰ç”¨)</label>
                        <input type="text" class="form-control" name="injury_name" placeholder="ä¾‹: å³è†ã®æ»æŒ«" value="{{ karte.injury_name if karte and karte.injury_name else '' }}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label fw-bold">å‚åŠ å¯å¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <select name="participation_status" class="form-select">
                            <option value="">-- é¸æŠ --</option>
                            {% for status in PARTICIPATION_STATUS_OPTIONS %}
                                <option value="{{ status }}" {% if karte and karte.participation_status == status %}selected{% endif %}>{{ status }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label fw-bold">å¾©å¸°/OUTäºˆå®š</label>
                        <input type="text" class="form-control" name="return_est" placeholder="ä¾‹: æ¥é€±å¾©å¸°äºˆå®š / å½“æ—¥åˆ¤æ–­" value="{{ karte.return_est if karte and karte.return_est else '' }}">
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-bold">ç¾çŠ¶ãƒ»çµŒéãƒ¡ãƒ¢</label>
                        <textarea class="form-control" name="progress_note" rows="2" placeholder="ä¾‹: è…«ã‚ŒãŒå¼•ã„ã¦ããŸãŸã‚ã‚¸ãƒ§ã‚°é–‹å§‹ã€‚">{{ karte.progress_note if karte and karte.progress_note else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="date" class="form-label">æ—¥ä»˜</label>
                <input type="date" class="form-control" id="date" name="date" 
                       value="{{ karte.date if karte and karte.date else today }}" required>
            </div>
            
            <div class="col-md-3 mb-3">
                <label for="player_id" class="form-label">é¸æ‰‹å (å¿…é ˆ)</label>
                <select name="player_id" id="player_id" class="form-select" required>
                    <option value="">é¸æ‰‹ã‚’é¸æŠ</option>
                    {% for player in player_list %}
                        <option value="{{ player.player_id }}" 
                                {% if karte and karte.player_id|string == player.player_id|string %}selected{% endif %}>
                            {{ player.player_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3 mb-3">
                <label for="tr" class="form-label">ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼/æ‹…å½“è€…</label>
                <input type="text" class="form-control" id="tr" name="tr" 
                       value="{{ karte.tr if karte and karte.tr else '' }}">
            </div>

            <div class="col-md-3 mb-3">
                <label for="time_loss_category" class="form-label">ã‚¿ã‚¤ãƒ ãƒ­ã‚¹åŒºåˆ†</label>
                <select name="time_loss_category" id="time_loss_category" class="form-select">
                    {% for tl in TIME_LOSS_OPTIONS %}
                        <option value="{{ tl }}" 
                                {% if karte and karte.time_loss_category == tl %}selected{% endif %}>
                            {{ tl }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6 d-flex align-items-end">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="diagnosis_flag" name="diagnosis_flag"
                           {% if karte and karte.diagnosis_flag %}checked{% endif %}>
                    <label class="form-check-label" for="diagnosis_flag">è¨ºæ–­ç¢ºå®šæ¸ˆ (ğŸ¥)</label>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h4>SOAP è¨˜éŒ²</h4>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="s_content" class="form-label">S (Subjective)</label>
                    <textarea class="form-control" id="s_content" name="s_content" rows="3">{{ karte.s_content if karte and karte.s_content else '' }}</textarea>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="o_content" class="form-label">O (Objective)</label>
                    <textarea class="form-control" id="o_content" name="o_content" rows="3">{{ karte.o_content if karte and karte.o_content else '' }}</textarea>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="a_content" class="form-label">A (Assessment)</label>
                    <textarea class="form-control" id="a_content" name="a_content" rows="3">{{ karte.a_content if karte and karte.a_content else '' }}</textarea>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="p_content" class="form-label">P (Plan)</label>
                    <textarea class="form-control" id="p_content" name="p_content" rows="3">{{ karte.p_content if karte and karte.p_content else '' }}</textarea>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h4>å‚·å®³è©³ç´° (çµ±è¨ˆç”¨)</h4>
            <div class="row">
                {% for key, details in PULLDOWN_OPTIONS.items() %}
                <div class="col-md-3 mb-3">
                    <label for="{{ key }}" class="form-label">{{ details.label }}</label>
                    <select name="{{ key }}" id="{{ key }}" class="form-select">
                        <option value="">-- é¸æŠãªã— --</option>
                        {% for option in details.options %}
                            <option value="{{ option }}" 
                                    {% if karte and karte[key]|string == option|string %}selected{% endif %}>
                                {{ option }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="d-flex justify-content-between mb-5">
            <div>
                <button type="submit" class="btn btn-primary me-2">ä¿å­˜ã™ã‚‹</button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary me-2">æˆ»ã‚‹</a>
                
                {% if action == 'edit' %}
                    <a href="{{ url_for('create_karte', copy_from_id=karte.karte_id) }}" class="btn btn-success">
                        <i class="fas fa-copy"></i> ã“ã®å†…å®¹ã§ã‚³ãƒ”ãƒ¼ä½œæˆ
                    </a>
                {% endif %}
            </div>
            
            {% if action == 'edit' and karte.karte_id %}
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    å‰Šé™¤
                </button>
            {% endif %}
        </div>
    </form>
    
    {% if action == 'edit' and karte.karte_id %}
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å‰Šé™¤ç¢ºèª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    ã“ã®ã‚«ãƒ«ãƒ†ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <form method="POST" action="{{ url_for('delete_karte', karte_id=karte.karte_id) }}" style="display:inline;">
                        <button type="submit" class="btn btn-danger">å‰Šé™¤å®Ÿè¡Œ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<script>
    function toggleReportFields() {
        var checkbox = document.getElementById('report_flag');
        var fields = document.getElementById('report_fields');
        if (checkbox && fields) {
            fields.style.display = checkbox.checked ? 'block' : 'none';
        }
    }
    document.addEventListener('DOMContentLoaded', toggleReportFields);
</script>
{% endblock %}